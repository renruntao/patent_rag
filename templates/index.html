<!DOCTYPE html>
<html>
<head>
    <title>专利问答数据管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 添加 Font Awesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f6fa;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
        }

        body {
            background-color: var(--secondary-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container-fluid {
            padding: 20px;
            max-width: 98%;
            margin: 0 auto;
        }

        .system-header {
            background: linear-gradient(135deg, var(--primary-color), #357abd);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .system-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .form-select, .form-control {
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 10px;
            transition: all 0.3s ease;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }

        .data-container, .generated-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .table {
            width: 100%;
            white-space: normal;
        }

        .table td {
            max-width: 300px;
            word-wrap: break-word;
        }

        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background-color: rgba(74, 144, 226, 0.05);
        }

        .btn {
            border-radius: 6px;
            padding: 8px 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            height: 38px !important;
            line-height: 24px !important;
            font-size: 14px !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
        }

        .btn-success {
            background-color: var(--success-color);
            border: none;
        }

        .btn-danger {
            background-color: var(--danger-color);
            border: none;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::after {
            width: 300px;
            height: 300px;
        }

        .nav-tabs {
            border-bottom: 2px solid #eee;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #666;
            padding: 12px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            background: none;
        }

        .qa-pair-item {
            background: white;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            word-wrap: break-word;
            transform-origin: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .qa-pair-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transform: translateY(-5px) scale(1.01);
        }

        .qa-pair-item textarea.question-input {
            min-height: 40px;
            max-height: 80px;
        }

        .qa-pair-item textarea.answer-input {
            min-height: 120px;
        }

        .qa-pair-item .form-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .generated-question {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .generated-question:hover {
            background-color: #eef2f7;
        }

        .form-check-input {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .pagination {
            margin-top: 20px;
            justify-content: center;
        }

        .pagination .page-link {
            color: var(--primary-color);
            border: none;
            padding: 8px 16px;
            margin: 0 4px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            color: white;
        }

        /* 添加动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .qa-pair-item {
            animation: fadeIn 0.5s ease-out;
        }

        /* 加载动画 */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(74, 144, 226, 0.2);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading i {
            color: var(--primary-color);
            font-size: 2em;
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #357abd;
        }

        /* 标签页切换动画 */
        .tab-pane {
            transition: opacity 0.3s ease-in-out;
        }

        .tab-pane.fade {
            opacity: 0;
        }

        .tab-pane.fade.show {
            opacity: 1;
        }

        /* 文本框焦点效果 */
        textarea:focus {
            transform: scale(1.01);
        }

        /* 工具提示 */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
        }

        .search-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .search-box .input-group {
            max-width: 600px;
        }

        .search-box input[type="text"] {
            height: 38px !important;
            min-height: 38px !important;
            max-height: 38px !important;
            resize: none !important;
            overflow: hidden !important;
            line-height: 20px !important;
            padding: 8px 12px !important;
            white-space: nowrap !important;
            text-overflow: ellipsis !important;
        }

        .search-box .btn {
            height: 38px !important;
            min-height: 38px !important;
            max-height: 38px !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-result {
            font-size: 0.9em;
            color: #666;
            margin-top: 8px;
            height: 20px;
        }

        .highlight {
            background-color: #fff3cd;
            padding: 2px;
            border-radius: 2px;
        }

        #searchInput {
            border-right: none;
            height: 38px !important;
            min-height: 38px !important;
            max-height: 38px !important;
        }

        #searchInput:focus + .btn-outline-primary {
            border-color: var(--primary-color);
            border-left: none;
        }

        .btn-outline-primary {
            border-left: none;
        }

        .search-box .input-group:focus-within {
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
            border-radius: 8px;
        }

        .lang-zh, .lang-en {
            transition: opacity 0.3s ease;
        }
        .d-none {
            display: none !important;
        }

        /* 移除搜索框的自动增长事件监听 */
        .search-box input[type="text"]::-webkit-resizer {
            display: none !important;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        
        .language-switcher .btn {
            padding: 6px 12px;
            font-size: 14px;
            min-width: 100px;
            height: 34px !important;
            min-height: 34px !important;
            max-height: 34px !important;
        }
        
        .language-switcher .btn-outline-light:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* 特殊按钮样式覆盖 */
        .btn-sm {
            height: 31px !important;
            line-height: 20px !important;
            padding: 4px 8px !important;
            font-size: 12px !important;
        }

        /* 导出按钮固定样式 */
        .export-btn {
            width: auto !important;
            min-width: 100px !important;
            max-width: 150px !important;
        }

        /* 修改生成按钮样式 */
        .generate-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s ease;
            border-radius: 6px;
            font-size: 13px !important;
            height: 32px !important;
            min-width: 80px !important;
            max-width: 100px !important;
        }

        .generate-btn:hover {
            background-color: #357abd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .generate-btn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .generate-btn i {
            font-size: 14px;
            margin-right: 4px;
        }

        /* 表格中的生成按钮特殊样式 */
        .table .generate-btn {
            padding: 4px 8px;
            font-size: 12px !important;
            height: 28px !important;
        }

        /* 删除按钮固定样式 */
        .delete-btn {
            width: auto !important;
            min-width: 60px !important;
            max-width: 80px !important;
        }

        /* 修复文本区域自动增长问题 */
        textarea {
            resize: vertical !important;
        }

        /* 搜索框特殊处理 */
        .search-box input[type="text"] {
            resize: none !important;
        }
    </style>
</head>
<body>
    <!-- 添加加载动画 -->
    <div class="loading">
        <div class="loading-spinner"></div>
        <div class="mt-3">正在生成问题...</div>
    </div>

    <div class="container-fluid">
        <div class="system-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-database me-2"></i><span class="lang-zh">專利問答數據管理系統</span><span class="lang-en d-none">Patent Q&A Data Management System</span></h2>
                <div class="btn-group language-switcher">
                    <button class="btn btn-outline-light" onclick="switchLanguage('zh')">繁體中文</button>
                    <button class="btn btn-outline-light" onclick="switchLanguage('en')">English</button>
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label" data-lang="roleTitle">選擇角色</label>
                    <select id="roleSelect" class="form-select">
                        <option value="">請選擇角色</option>
                        {% for role_id, role in roles.items() %}
                        <option value="{{ role_id }}">{{ role.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-lang="countTitle">生成數量</label>
                    <input type="number" id="countInput" class="form-control" placeholder="請輸入生成數量">
                </div>
                <div class="col-md-4">
                    <label class="form-label" data-lang="uploadTitle">上傳文件</label>
                    <div class="input-group">
                        <input type="file" id="fileInput" class="form-control" accept=".csv">
                        <span class="input-group-text"><i class="fas fa-upload"></i></span>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col">
                    <label class="form-label" data-lang="promptTitle">系統提示詞</label>
                    <textarea id="promptInput" class="form-control" rows="4" placeholder="請輸入系統提示詞"></textarea>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="data-container" id="dataContainer">
                    <div class="search-box mb-3">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" data-lang-placeholder="searchPlaceholder">
                            <button class="btn btn-outline-primary" type="button" onclick="performSearch()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th width="8%" data-lang="serialNumber">序號</th>
                                    <th width="42%" data-lang="questionTitle">問題</th>
                                    <th width="42%" data-lang="answerTitle">答案</th>
                                    <th width="8%" data-lang="operationTitle">操作</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                            </tbody>
                        </table>
                    </div>
                    <nav>
                        <ul class="pagination" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
            <div class="col-md-6">
                <div class="generated-container">
                    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="generate-tab" data-bs-toggle="tab" href="#generateContent" role="tab" data-lang="generateResultsTab">生成結果</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="pairs-tab" data-bs-toggle="tab" href="#pairsContent" role="tab" data-lang="savedPairsTab">已保存問答對</a>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="resultTabContent">
                        <div class="tab-pane fade show active" id="generateContent" role="tabpanel">
                            <div class="d-flex justify-content-between mb-2">
                                <h4>生成結果</h4>
                                <button class="btn btn-primary generate-btn" data-tooltip="生成新的問題" onclick="generateQuestions(currentIndex)">
                                    <i class="fas fa-magic"></i>
                                    <span>生成</span>
                                </button>
                            </div>
                            <div id="generatedContent" class="border p-3">
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="pairsContent" role="tabpanel">
                            <div class="d-flex justify-content-between mb-2">
                                <h4>已保存問答對</h4>
                                <button class="btn btn-primary export-btn" onclick="exportSavedPairs()" data-lang="exportData">導出問答對</button>
                            </div>
                            <div id="savedPairsContent" class="qa-pair-list">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let generatedData = [];
        let currentPage = 1;
        let totalPages = 1;
        const perPage = "{{ per_page }}";
        let savedQAPairs = []; // 存储已保存的问答对
        let filteredData = []; // 添加用于存储过滤后的数据

        const roles = JSON.parse('{{ roles|tojson|safe }}');

        document.getElementById('roleSelect').addEventListener('change', function(e) {
            const role = roles[e.target.value];
            if (role) {
                document.getElementById('promptInput').value = role.system_prompt;
                document.getElementById('countInput').value = role.default_count;
            }
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentData = data.data;
                    filteredData = [...currentData]; // 初始化过滤数据
                    totalPages = data.total_pages;
                    displayData();
                }
            });
        });

        function displayData(page = 1) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            const dataToUse = filteredData.length > 0 ? filteredData : currentData;
            const start = (page - 1) * perPage;
            const end = start + perPage;
            const pageData = dataToUse.slice(start, end);
            
            pageData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['序號']}</td>
                    <td>${highlightSearchTerm(row['題目'])}</td>
                    <td>${highlightSearchTerm(row['解答'])}</td>
                    <td>
                        <button class="generate-btn" data-tooltip="生成新的問題" onclick="generateQuestions(${start + index})">
                            <i class="fas fa-magic"></i>
                            <span>生成</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updatePagination(page);
        }

        function updatePagination(currentPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                `;
                pagination.appendChild(li);
            }
        }

        function changePage(page) {
            currentPage = page;
            displayData(page);
        }

        // 添加加载动画控制
        function showLoading() {
            document.querySelector('.loading').style.display = 'block';
        }

        function hideLoading() {
            document.querySelector('.loading').style.display = 'none';
        }

        // 修改生成问题函数，添加加载动画
        function generateQuestions(rowIndex) {
            showLoading();
            const role = document.getElementById('roleSelect').value;
            const count = document.getElementById('countInput').value;
            const prompt = document.getElementById('promptInput').value;

            if (!role || !count || !prompt) {
                alert('請填寫完整信息');
                hideLoading();
                return;
            }

            fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rowIndex,
                    role,
                    count,
                    prompt
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const generatedQuestions = data.generated.split('\n').filter(q => q.trim());
                    document.getElementById('generatedContent').innerHTML += `
                        <div class="qa-pair" data-row-index="${rowIndex}">
                            <h5>原始問題: ${currentData[rowIndex]['題目']}</h5>
                            <div class="answer">
                                <strong>原始答案:</strong><br>
                                ${currentData[rowIndex]['解答']}
                            </div>
                            <div class="generated-questions">
                                <h6>生成的问题:</h6>
                                ${generatedQuestions.map((q, i) => `
                                    <div class="generated-question">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="" id="question-${generatedData.length}-${i}">
                                            <textarea class="form-control" onchange="updateGeneratedQuestion(${generatedData.length}, ${i}, this.value)">${q}</textarea>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="generated-controls mt-3">
                                <button class="btn btn-success" onclick="saveSelectedQuestions(${generatedData.length})">保存選中的問題</button>
                                <button class="btn btn-info" onclick="jumpToOriginal(${rowIndex})">跳轉到原始問答</button>
                            </div>
                        </div>
                    `;
                    generatedData.push({
                        original: currentData[rowIndex],
                        generated: generatedQuestions
                    });
                } else {
                    alert(data.error || '生成問題時出錯');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('請求失敗，請檢查網絡連接');
            })
            .finally(() => {
                hideLoading();
            });
        }

        function updateGeneratedQuestion(dataIndex, questionIndex, newValue) {
            generatedData[dataIndex].generated[questionIndex] = newValue;
        }

        function saveSelectedQuestions(dataIndex) {
            const container = document.querySelector(`[data-row-index="${dataIndex}"]`);
            const selectedQuestions = container.querySelectorAll('.generated-question');
            let hasSelected = false;
            
            selectedQuestions.forEach((questionDiv, index) => {
                const checkbox = questionDiv.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    hasSelected = true;
                    const questionText = questionDiv.querySelector('textarea').value;
                    savedQAPairs.push({
                        question: questionText,
                        answer: generatedData[dataIndex].original.解答,
                        originalQuestion: generatedData[dataIndex].original.題目
                    });
                }
            });

            if (hasSelected) {
                updateSavedPairsDisplay();
                // 切换到已保存问答对标签页
                const pairsTab = document.querySelector('#pairs-tab');
                const tab = new bootstrap.Tab(pairsTab);
                tab.show();
            } else {
                alert(translations[currentLang].pleaseSelectQuestions);
            }
        }

        function updateSavedPairsDisplay(lang = currentLang) {
            const container = document.getElementById('savedPairsContent');
            container.innerHTML = savedQAPairs.map((pair, index) => `
                <div class="qa-pair-item" data-pair-index="${index}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>${translations[lang].question} ${index + 1}</h6>
                        <div>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deletePair(${index})" data-lang="deleteButton">
                                ${translations[lang].deleteButton}
                            </button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">問題:</label>
                        <textarea class="form-control question-input" onchange="updatePairQuestion(${index}, this.value)">${pair.question}</textarea>
                    </div>
                    <div class="answer mb-2">
                        <label class="form-label">答案:</label>
                        <textarea class="form-control answer-input" onchange="updatePairAnswer(${index}, this.value)">${pair.answer}</textarea>
                    </div>
                    <div class="text-muted mt-2">
                        <small>來源問題: ${pair.originalQuestion}</small>
                    </div>
                </div>
            `).join('');
        }

        function updatePairQuestion(index, newValue) {
            savedQAPairs[index].question = newValue;
        }

        function updatePairAnswer(index, newValue) {
            savedQAPairs[index].answer = newValue;
        }

        function deletePair(index) {
            if (confirm('確定要刪除這個問答對嗎？')) {
                savedQAPairs.splice(index, 1);
                updateSavedPairsDisplay();
            }
        }

        function jumpToOriginal(rowIndex) {
            const pageNumber = Math.floor(rowIndex / perPage) + 1;
            changePage(pageNumber);
            
            // 高亮顯示原始行
            setTimeout(() => {
                const rows = document.querySelectorAll('#dataTableBody tr');
                const targetRow = rows[rowIndex % perPage];
                if (targetRow) {
                    targetRow.style.backgroundColor = '#fff3cd';
                    setTimeout(() => {
                        targetRow.style.backgroundColor = '';
                    }, 2000);
                }
            }, 100);
        }

        function exportData() {
            fetch('/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: generatedData
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'generated_data.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            });
        }

        function exportSavedPairs() {
            // 添加 BOM 頭以解決 Excel 打開中文亂碼
            const BOM = "\uFEFF";
            const headers = ["問題", "答案", "原始問題"];
            const csvContent = BOM + 
                headers.join(',') + '\n' +
                savedQAPairs.map(pair => {
                    return [
                        `"${pair.question.replace(/"/g, '""')}"`,
                        `"${pair.answer.replace(/"/g, '""')}"`,
                        `"${pair.originalQuestion.replace(/"/g, '""')}"`
                    ].join(',');
                }).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "saved_qa_pairs.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // 為複選框添加事件監聽
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && e.target.closest('.generated-question')) {
                const answerInput = e.target.closest('.generated-question').querySelector('.answer-input');
                answerInput.style.display = e.target.checked ? 'block' : 'none';
            }
        });

        // 在頁面加載時添加樣式
        document.addEventListener('DOMContentLoaded', addStyles);

        function addStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .qa-pair-item {
                    background-color: #fff;
                    border: 1px solid #ddd;
                    padding: 15px;
                    margin-bottom: 15px;
                    border-radius: 5px;
                }
                .qa-pair-item:hover {
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                }
                .qa-pair-item textarea {
                    width: 100%;
                    margin: 5px 0;
                    min-height: 60px;
                }
                .qa-pair-item .form-label {
                    font-weight: 500;
                    margin-bottom: 5px;
                }
                .qa-pair-item .answer textarea {
                    background-color: #f8f9fa;
                }
            `;
            document.head.appendChild(style);
        }

        // 添加表單驗證
        function validateForm() {
            const role = document.getElementById('roleSelect').value;
            const count = document.getElementById('countInput').value;
            const prompt = document.getElementById('promptInput').value;

            if (!role) {
                showToast('請選擇角色');
                return false;
            }
            if (!count || count < 1) {
                showToast('請輸入有效的生成數量');
                return false;
            }
            if (!prompt.trim()) {
                showToast('請輸入系統提示詞');
                return false;
            }
            return true;
        }

        // 添加按鈕點擊波紋效果
        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('div');
                ripple.className = 'ripple';
                this.appendChild(ripple);
                
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = e.clientX - rect.left - size/2 + 'px';
                ripple.style.top = e.clientY - rect.top - size/2 + 'px';
                
                ripple.addEventListener('animationend', () => {
                    ripple.remove();
                });
            });
        });

        // 添加平滑滾動
        function smoothScroll(target) {
            const element = document.querySelector(target);
            element.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // 優化 Toast 提示
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast show toast-${type}`;
            toast.style.animation = 'slideIn 0.5s ease-out';
            
            toast.innerHTML = `
                <div class="toast-header">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    <strong class="me-auto">${type === 'success' ? '成功' : '提示'}</strong>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;

            const container = document.getElementById('toastContainer') || (() => {
                const div = document.createElement('div');
                div.id = 'toastContainer';
                div.style.position = 'fixed';
                div.style.top = '20px';
                div.style.right = '20px';
                div.style.zIndex = '1050';
                document.body.appendChild(div);
                return div;
            })();

            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.5s ease-in';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // 修改文本框自动增长的代码，排除搜索框
        document.querySelectorAll('.qa-pair-item textarea, #promptInput').forEach(textarea => {
            textarea.addEventListener('input', function() {
                // 确保不是搜索框
                if (!this.closest('.search-box')) {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight + 2) + 'px';
                }
            });
        });

        // 添加搜索功能
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm.trim() === '') {
                filteredData = [...currentData];
            } else {
                filteredData = currentData.filter(item => 
                    item['題目'].toLowerCase().includes(searchTerm) ||
                    item['解答'].toLowerCase().includes(searchTerm)
                );
            }
            
            // 重新計算總頁數
            totalPages = Math.ceil(filteredData.length / perPage);
            
            // 重置到第一頁並顯示結果
            currentPage = 1;
            displayData(1);
            
            // 顯示搜索結果數量
            showSearchResults(filteredData.length);
        }

        // 顯示搜索結果數量
        function showSearchResults(count) {
            const searchBox = document.querySelector('.search-box');
            const existingResult = searchBox.querySelector('.search-result');
            if (existingResult) {
                existingResult.remove();
            }
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'search-result mt-2 text-muted';
            resultDiv.innerHTML = `找到 ${count} 條相關記錄`;
            searchBox.appendChild(resultDiv);
        }

        // 高亮搜索關鍵詞
        function highlightSearchTerm(text) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return text;
            
            const regex = new RegExp(searchTerm, 'gi');
            return text.replace(regex, match => `<mark class="highlight">${match}</mark>`);
        }

        // 添加搜索框的回車事件監聽
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // 语言文本映射
        const translations = {
            zh: {
                selectRole: '選擇角色',
                generateCount: '生成數量',
                uploadFile: '上傳文件',
                systemPrompt: '系統提示詞',
                searchPlaceholder: '搜索問題或答案...',
                generate: '生成',
                export: '導出數據',
                delete: '刪除',
                question: '問題',
                answer: '答案',
                originalQuestion: '來源問題',
                saveSelected: '保存選中的問題',
                confirmDelete: '確定要刪除這個問答對嗎？',
                searchResults: '找到 {count} 條相關記錄',
                generateResults: '生成結果',
                savedPairs: '已保存問答對',
                noFileSelected: '未選擇文件',
                pleaseSelectRole: '請選擇角色',
                pleaseInputCount: '請輸入生成數量',
                pleaseInputPrompt: '請輸入系統提示詞',
                loading: '正在生成問題...',
                serialNumber: '序號',
                operation: '操作',
                exportData: '導出數據',
                generateNew: '生成新的問題',
                jumpToOriginal: '跳轉到原始問答',
                inputSystemPrompt: '請輸入系統提示詞',
                roleTitle: '選擇角色',
                countTitle: '生成數量',
                uploadTitle: '上傳文件',
                promptTitle: '系統提示詞',
                searchTitle: '搜索',
                questionTitle: '問題',
                answerTitle: '答案',
                operationTitle: '操作',
                chooseFile: '選擇文件',
                inputPrompt: '請輸入系統提示詞',
                pleaseSelectQuestions: '請選擇要保存的問題',
                generateButton: '生成',
                saveButton: '保存選中的問題',
                deleteButton: '刪除',
                jumpButton: '跳轉到原始問答',
                pleaseSelectQuestions: '請選擇要保存的問題',
                originalQuestionLabel: '原始問題',
                originalAnswerLabel: '原始答案',
                generatedQuestionsLabel: '生成的問題',
                noQuestionsGenerated: '尚未生成任何問題',
                pleaseComplete: '請填寫完整信息',
                requestFailed: '請求失敗，請檢查網絡連接',
                generationError: '生成問題時出錯'
            },
            en: {
                selectRole: 'Select Role',
                generateCount: 'Generate Count',
                uploadFile: 'Upload File',
                systemPrompt: 'System Prompt',
                searchPlaceholder: 'Search questions or answers...',
                generate: 'Generate',
                export: 'Export Data',
                delete: 'Delete',
                question: 'Question',
                answer: 'Answer',
                originalQuestion: 'Source Question',
                saveSelected: 'Save Selected Questions',
                confirmDelete: 'Are you sure to delete this Q&A pair?',
                searchResults: 'Found {count} related records',
                generateResults: 'Generation Results',
                savedPairs: 'Saved Q&A Pairs',
                noFileSelected: 'No file selected',
                pleaseSelectRole: 'Please select a role',
                pleaseInputCount: 'Please input generation count',
                pleaseInputPrompt: 'Please input system prompt',
                loading: 'Generating questions...',
                serialNumber: 'No.',
                operation: 'Operation',
                exportData: 'Export Data',
                generateNew: 'Generate New',
                jumpToOriginal: 'Jump to Original',
                inputSystemPrompt: 'Please input system prompt',
                roleTitle: 'Select Role',
                countTitle: 'Generate Count',
                uploadTitle: 'Upload File',
                promptTitle: 'System Prompt',
                searchTitle: 'Search',
                questionTitle: 'Question',
                answerTitle: 'Answer',
                operationTitle: 'Operation',
                chooseFile: 'Choose File',
                inputPrompt: 'Please input system prompt',
                pleaseSelectQuestions: 'Please select questions to save',
                generateButton: 'Generate',
                saveButton: 'Save Selected Questions',
                deleteButton: 'Delete',
                jumpButton: 'Jump to Original',
                pleaseSelectQuestions: 'Please select questions to save',
                originalQuestionLabel: 'Original Question',
                originalAnswerLabel: 'Original Answer',
                generatedQuestionsLabel: 'Generated Questions',
                noQuestionsGenerated: 'No questions generated yet',
                pleaseComplete: 'Please complete all information',
                requestFailed: 'Request failed, please check network connection',
                generationError: 'Error generating questions'
            }
        };

        // 切换语言函数
        function switchLanguage(lang) {
            currentLang = lang; // 设置当前语言

            // 更新所有带有 data-lang 属性的元素
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // 更新所有输入框的 placeholder
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // 更新动态生成的内容
            updateGeneratedContent(lang);
            updateSavedPairsDisplay(lang);

            // 更新角色选择下拉框
            const roleSelect = document.getElementById('roleSelect');
            roleSelect.innerHTML = `<option value="">${translations[lang].pleaseSelectRole}</option>` +
                Object.entries(roles).map(([id, role]) => `
                    <option value="${id}">${lang === 'zh' ? role.name : role.name_en}</option>
                `).join('');
        }

        // 更新生成的内容
        function updateGeneratedContent(lang) {
            const generatedContent = document.getElementById('generatedContent');
            if (generatedData.length > 0) {
                generatedContent.querySelectorAll('[data-lang]').forEach(el => {
                    const key = el.dataset.lang;
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
            }
        }

        // 更新已保存的问答对显示
        function updateSavedPairsDisplay(lang = currentLang) {
            const container = document.getElementById('savedPairsContent');
            container.innerHTML = savedQAPairs.map((pair, index) => `
                <div class="qa-pair-item" data-pair-index="${index}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>${translations[lang].question} ${index + 1}</h6>
                        <div>
                            <button class="btn btn-sm btn-danger delete-btn" onclick="deletePair(${index})" data-lang="deleteButton">
                                ${translations[lang].deleteButton}
                            </button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">問題:</label>
                        <textarea class="form-control question-input" onchange="updatePairQuestion(${index}, this.value)">${pair.question}</textarea>
                    </div>
                    <div class="answer mb-2">
                        <label class="form-label">答案:</label>
                        <textarea class="form-control answer-input" onchange="updatePairAnswer(${index}, this.value)">${pair.answer}</textarea>
                    </div>
                    <div class="text-muted mt-2">
                        <small>${translations[lang].originalQuestionLabel}: ${pair.originalQuestion}</small>
                    </div>
                </div>
            `).join('');
        }

        // 页面加载时初始化语言
        document.addEventListener('DOMContentLoaded', () => {
            switchLanguage('zh'); // 默认使用繁体中文
        });
    </script>
</body>
</html> 